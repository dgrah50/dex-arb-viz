<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Price Feed Dashboard</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .status {
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 4px;
        text-align: center;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
      }
      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .price-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .price-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .price-card h2 {
        margin: 0 0 15px 0;
        color: #333;
      }
      .price-source {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 4px;
        background-color: #f8f9fa;
      }
      .price-value {
        font-weight: bold;
        font-size: 1.2em;
      }
      .timestamp {
        color: #666;
        font-size: 0.8em;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Price Feed Dashboard</h1>
      <div id="connection-status" class="status disconnected">Disconnected</div>
    </div>
    <div id="price-grid" class="price-grid">
      <!-- Price cards will be dynamically inserted here -->
    </div>

    <script>
      const priceData = new Map(); // Store latest prices for each symbol and source
      const ws = new WebSocket("ws://localhost:3000");
      const statusElement = document.getElementById("connection-status");
      const priceGrid = document.getElementById("price-grid");

      ws.onopen = () => {
        statusElement.textContent = "Connected";
        statusElement.className = "status connected";
      };

      ws.onclose = () => {
        statusElement.textContent = "Disconnected";
        statusElement.className = "status disconnected";
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        statusElement.textContent = "Error: " + error.message;
        statusElement.className = "status disconnected";
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        updatePrice(data);
      };

      function updatePrice(data) {
        const key = data.symbol;
        if (!priceData.has(key)) {
          priceData.set(key, new Map());
          createPriceCard(key);
        }

        const symbolData = priceData.get(key);
        symbolData.set(data.source, {
          price: data.price,
          timestamp: data.timestamp,
        });

        updatePriceCard(key);
      }

      function createPriceCard(symbol) {
        const card = document.createElement("div");
        card.className = "price-card";
        card.id = `card-${symbol}`;
        card.innerHTML = `
                <h2>${symbol}</h2>
                <div class="price-source reya">
                    <span>Reya</span>
                    <span class="price-value">-</span>
                </div>
                <div class="timestamp reya-time"></div>
                <div class="price-source vertex">
                    <span>Vertex</span>
                    <span class="price-value">-</span>
                </div>
                <div class="timestamp vertex-time"></div>
            `;
        priceGrid.appendChild(card);
      }

      function updatePriceCard(symbol) {
        const card = document.getElementById(`card-${symbol}`);
        const symbolData = priceData.get(symbol);

        ["reya", "vertex"].forEach((source) => {
          const data = symbolData.get(source);
          if (data) {
            const priceElement = card.querySelector(
              `.price-source.${source} .price-value`
            );
            const timeElement = card.querySelector(`.timestamp.${source}-time`);

            priceElement.textContent = `$${data.price.toFixed(2)}`;
            timeElement.textContent = new Date(
              data.timestamp
            ).toLocaleTimeString();
          }
        });
      }
    </script>
  </body>
</html>
